
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@Lenciel</title>
  <meta name="author" content="Lenciel Li">

  
  <meta name="description" content="去年创业界的一大盛事就是YC的CEO，斯坦福的退学生Sam Altman联手斯坦福大学，开设了课程CS183B：How To Start A Startup。十周共20节课程请来了各路顶尖人才，从创意、产品、团队和执行这四个YC认为创业最关键的维度分享了如何进行创业。 如果你自己是创业者， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lenciel.cn">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr.custom.55630.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml">
  
<meta property="og:type" content="article" />
<meta property="og:url" content="http://lenciel.cn" />
<meta property="og:description" content="去年创业界的一大盛事就是YC的CEO，斯坦福的退学生Sam Altman联手斯坦福大学，开设了课程CS183B：How To Start A Startup。十周共20节课程请来了各路顶尖人才，从创意、产品、团队和执行这四个YC认为创业最关键的维度分享了如何进行创业。 如果你自己是创业者， &hellip;" />

<meta property="og:site_name" content="http://lenciel.cn" />
<meta property="article:author" content="http://lenciel.cn">



<meta itemprop="description" content="去年创业界的一大盛事就是YC的CEO，斯坦福的退学生Sam Altman联手斯坦福大学，开设了课程CS183B：How To Start A Startup。十周共20节课程请来了各路顶尖人才，从创意、产品、团队和执行这四个YC认为创业最关键的维度分享了如何进行创业。 如果你自己是创业者， &hellip;" />


<!-- Combine multiple fonts into one request -->
<link href="http://fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic|Patua+One|Yanone+Kaffeesatz" rel="stylesheet" type="text/css">

<script src="/javascripts/libs/fastclick.js"></script>
<script>
  FastClick.attach(document.body);
</script>




  <script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F2f0a0a00f439ab96a80a199638ef8594' type='text/javascript'%3E%3C/script%3E"));
</script>


  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-175991-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">@Lenciel</a></h1>
  
    <h2>Thoughts and Rants.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lenciel.cn" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/"><i class="icon-home"></i>Home</a></li>
  <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li>
  <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/02/startup-advices-from-sam-altman/">Sam Altman给创业者的建议</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-22T22:22:00+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:22 pm</span></time>
        
           | <a href="/2015/02/startup-advices-from-sam-altman/#disqus_thread"
             data-disqus-identifier="http://lenciel.cn/2015/02/startup-advices-from-sam-altman/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>去年创业界的一大盛事就是YC的CEO，斯坦福的退学生<a href="http://blog.samaltman.com/">Sam Altman</a>联手斯坦福大学，开设了课程CS183B：<a href="http://startupclass.samaltman.com/">How To Start A Startup</a>。十周共20节课程请来了各路顶尖人才，从创意、产品、团队和执行这四个YC认为创业最关键的维度分享了如何进行创业。</p>

<p>如果你自己是创业者，个人建议是整个课程可以好好看一遍，反正就算你不会翻墙，因为YC巨大的号召力，国内也有人为这个课程专门做了<a href="http://startupclass.club/">镜像网站</a>并配了字幕。</p>

<p>如果你是蠢蠢欲动想要创业的人，不妨看看Sam Altman给出的这个课程的简化提纲，看看自己是不是适合这样的生活：</p>

<ul>
<li>创业应当从创意和想法开始，而不是一来就开一家公司。当创业还只是围绕一个创意或者一个项目的实现时，承受的压力会小很多，就更愿意接受那些看上去稀奇古怪但实则能量巨大的想法。就算非要开公司，最好的思路也是去集合各式各样好玩的想法并实施。</li>
<li>而与之相反，当你拥有了一家公司的时候，你会面临压力，从而导致对各种各样的想法产生过快的判断。而如果只是一个项目，你就可以花更多时间去确定它是不是真的是一个好的方向：这其实是非常重要的工作，因为创业真正开始之后，你将花费非常多的时间和精力投入到这个方向。</li>
<li>团队中，至少有一个技术合伙人（这个人能从技术角度去帮助实现公司希望拥有的任何产品）</li>
<li>通常来说，选择一个高增长市场远比选择一个份额巨大但增长缓慢的市场要好。特别是如果你发现的高增长市场正好是其他人忽视的。</li>
<li>最好的创业想法是那些看起来很糟但其实非常好的想法（你得具有非凡的信心和判断力）。</li>
<li>去创造直击人性的事物。即便是在其他点上都输得一塌糊涂，但只要做到这点就够了。另一方面，如果做不到这点，其他所有的点都非常出彩也都无济于事。</li>
<li>一旦将创业从“好玩的项目”切换成为公司运作，请果断而且迅速的行动。这时候，不能再花费数周做一项决定，而需要迅速试错：思考一个小时，在下一个小时就得到结果。</li>
<li>让自己变得强大，而且强硬。前进的道路会充满艰辛，即便你自己也会一次又一次的怀疑自己。</li>
<li>找到办法让自己的产品被它们的用户触碰到。一开始即便是靠人力也要做到这点（推荐阅读：<a href="http://www.paulgraham.com/ds.html">this</a>）。</li>
<li>倾听用户的声音，改善产品，然后继续倾听，直到一些用户开始爱上了你的产品（这时候，最好是一小撮，而不是一大群）。而且，请不要在用户是否喜欢你的产品这件事情上欺骗自己。</li>
<li>尽可能的降低你的资源消耗速度，直到你确定你的产品已经捕获了部分用户的芳心，而降低消耗的最简单的方法就是缓慢增加招聘。</li>
<li>规划商业策略，大多数人并没有这样做。然后，偶尔从另一个角度思考一下，如何抵抗自己制定的商业策略。请记住，在未来的某一天你会需要并且成为垄断者的 (in the Peter Thiel sense)。</li>
<li>在融资前一定读读<a href="Read%20this%20before%20you%20raise%20money:%20http://paulgraham.com/fr.html">这个</a></li>
<li>忽略媒体的报道，特别是那些称赞的报道。</li>
<li>在公司的早期就一定要盈利。</li>
<li>尽可能去雇佣那些最好的员工，无论你花费多少时间去寻找他们，都不过分。多给你的员工一些股份，提升他们的期望。聪明、高效的人总是渴望成功的。（推荐阅读：<a href="http://blog.samaltman.com/how-to-hire">this</a>）</li>
<li>当你发现自己雇佣了错误的员工之后，请迅速开除他。</li>
<li>不要和那些你合作起来感觉不那么良好的员工（甚至是合伙人）、伙伴、投资者一起共事。</li>
<li>尝试去摸索规模化获取用户的方法，这时候你需要做的是硬着头皮去学习销售和市场营销工作。顺道说一句，通过花费超过用户价值的价格去获取用户虽然在时下很流行，但请记住，这并不可取。</li>
<li>持续关注用户的增长速度，别停下来，这是衡量一个公司CEO是否合格的最好策略。如果你偶然发现自己说出了“我们的目标不是用户增长”这样的话，请仔细反省一下，自己是否把时间花费在了其他错误的事情上？当然，也记得别让自己被那些虚荣的指标欺骗。</li>
<li>一个成熟创业公司的状态是：公司每个人都能全身心投入到分配给自己的任务当中。这种投入对于几个创始人来说更是至关重要。创业圈里面流行的关于“传教士与雇佣兵”的区别的确存在，而且非常明显。</li>
<li>不要在那些无所谓的事情上浪费时间（这些事不包括产品开发、与用户沟通以及用户增长等，它们都很重要）。比如，沉溺于一部讲述如何创业的电影，与律师或会计开会，参加各式虚张声势的推广会议等。</li>
<li>相反，请将精力放在那些重要的事情上。每天找出两三件最重要的事，这时候变身成为一个工作机器，专注其中，忽略任何外部的干扰。</li>
<li>不要找任何借口，做需要被做的事情。</li>
<li>学习对团队的管理，让小伙伴们都开开心心的。千万别忽略了这点，真的非常重要。</li>
<li>除开创造一个伟大的产品，如果想真正成功，还需要创造一个伟大的公司，所以多花点时间去思考公司文化。</li>
<li>不要小看人脉关系的重要性。</li>
<li>在你真的确定想卖掉自己的心血之前，忽略那些收购意向。事实上，如果一些公司能够避免类似失误，他们也许已经非常成功了。不幸的是，它们过早被收购导致了关门。</li>
<li>努力工作，这是成功的不二法门。虽然每个人都希望走捷径，但目前看来尚未出现。</li>
<li>保持这种状态工作十年。</li>
</ul>


<p>个人觉得，说得非常实诚，真正在花心思做自己的产品的公司肯定能收益良多。当然，最后那句也是最关键的一句：毕竟是九死一生的创业嘛，回档再多次也是正常&hellip;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/02/p4f-tech-stack-part-2-others/">Palm4fun Tech Stack Review Part II</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-20T14:11:19+08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:11 pm</span></time>
        
           | <a href="/2015/02/p4f-tech-stack-part-2-others/#disqus_thread"
             data-disqus-identifier="http://lenciel.cn/2015/02/p4f-tech-stack-part-2-others/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>距离<a href="http://lenciel.cn/2015/01/p4f-tech-stack-part-1-devops/">上篇</a>略久，主要最近很忙。</p>

<a name="Application..amp..Data"></a>
<h2>Application &amp; Data</h2>

<p>和其他几个提供辅助的部分不同，App/Data这部分基本上就是产品本身了。</p>

<a name="Application.Hosting"></a>
<h3>Application Hosting</h3>

<p><img src="/downloads/images/2015_01/p4f_stack_app_data_1.png" title="Don't touch me..." alt="stack_devops_1" /></p>

<p>我们在选择云的时候，也有试用过“久负盛名”的几家大的。</p>

<ul>
<li>阿里因为性价比的原因直接被我忽略了</li>
<li>AWS显然是成熟度最高的，但是在国内用起来确实比较憋屈，希望他们正式入华后有好转</li>
<li>Google的Compute Engine和Windows Azure都属于开张不久，前者因为有打折劵最终被我用来做了很久的翻墙代理（但是也因为忘记关VPS收到了巨额账单，好在Google还比较厚道免单了）。后者因为在国内有部署，速度非常不错，但是整体比UCloud还是贵了不少。</li>
</ul>


<p>最终我们选择了UCloud，他们的价钱比较公道，服务也做得非常棒。虽然我们机器并不是很多，但是仍然有24小时随叫随到的服务团队在跟，并且服务团队的技术实力在国内的服务提供商里面也非常突出。</p>

<p>平时还有一些抛弃型的原型我会放到Heroku或者Google App Engine上，因为它们用来部署Django应用非常便捷。</p>

<p>我们大多数项目都只是简单的管理后台，用Apache还是Nginx并没有明显区别。因为Apache在大多数OS自带，所以基本上都是以Apache+uwsgi+supervisor来进行部署。</p>

<a name="Languages..amp..Frameworks"></a>
<h3>Languages &amp; Frameworks</h3>

<p><img src="/downloads/images/2015_01/p4f_stack_app_data_2.png" title="Don't touch me..." alt="stack_devops_1" /></p>

<p>这张图再画长一倍也不一定能画完，因为这部分特别是Web前端技术的变动实在是太大了。感觉JavaScript社区换框架、方法论、编译工具甚至是VM就像足球运动员换袜子一样勤。</p>

<p>所以我们的策略一直是不绑定到某个具体框架：那样很容易被绑架。从目前来看：</p>

<ul>
<li>React/Flux最近特别火，由Facebook内部使用并开源（特别是最近推出了React Native）。</li>
<li>AngularJS，火了很长时间，由Google内部使用并开源。目前两个主要版本变动太大嘴炮很多，可以观望到尘埃落定再考虑深入学习。</li>
<li>Backbone是非常不错的客户端MVC框架。</li>
<li>node.js和io.js。目前它们是一样的东西，io.js只是node.js的一个fork（类似于Hudson和Jenkins的关系）。目前可以只学node.js但是得盯着io.js的发展，因为很多原来node.js的主力都在io.js这边。</li>
<li>npm是Javascript目前最主要的package管理工具。目前你还会听说bower但几乎大家都已经确认这是个愚蠢的idea。另外你还会听说jspm，一个很新的系统，非常不错，值得留意。</li>
<li>Browserify使得你可以在browser里面直接使用npm的module，而不仅仅是在server端。完全是一次革命，非常好用。</li>
<li>Gulp和Grunt是build工具（类比Ant/Maven），Gulp更新而且设计上非常成熟，推荐学习和使用Gulp。</li>
<li>express.js是服务器端JS应用开发需要学习的东西。</li>
<li>Meteor是设计非常领先的一个全栈的框架（想想Django），整体上非常酷，目前也很流行。如果你想试试自己的学习能力和承受能力，值得一试。</li>
<li>jQuery之于JavaScript就好比少林寺之于中华武术。每个人都在学，都以为它就可以搞定整个武林，但那是错的。JQuery是用来对DOM做操作的，如果你用它在干别的，你多半错了。</li>
</ul>


<a name="Assets..amp..Media"></a>
<h3>Assets &amp; Media</h3>

<p><img src="/downloads/images/2015_01/p4f_stack_app_data_3.png" title="Don't touch me..." alt="stack_devops_1" /></p>

<p>这方面没什么好说的，一开始我们用的就是UCloud自带的服务。后面为Testbird开发项目的时候接触到了七牛云。不得不吐槽一下七牛云还处于快速增长期，不论是提供的服务的稳定性，还是文档更新的及时性，都还有很多值得提高的地方。</p>

<a name="Data.Storage"></a>
<h3>Data Storage</h3>

<p><img src="/downloads/images/2015_01/p4f_stack_app_data_4.png" title="Don't touch me..." alt="stack_app_data_4" /></p>

<p>数据库我们一般本地开发用SQLite，stage和prod服务器用MySQL。之所以没有选择Postgresql是因为它那些很不错的功能我们在项目里面还没有需要，所以就偷懒选择了自己更熟悉的系统。</p>

<a name="Libraries"></a>
<h3>Libraries</h3>

<p><img src="/downloads/images/2015_01/p4f_stack_app_data_5.png" title="Don't touch me..." alt="stack_app_data_5" /></p>

<p>这张图也是很难画完整的，因为它一直在变。不过我们基本上用ACE封装了一套自己的UI框架，对提高开发效率还是非常有用的。</p>

<a name="Utilities"></a>
<h2>Utilities</h2>

<p><img src="/downloads/images/2015_01/p4f_stack_utilities.png" title="Don't touch me..." alt="stack_utilities" /></p>

<p>都是些中规中矩的选择，因为好的服务都在国内被封堵得比较彻底，不是吗？</p>

<p>比如统计，百度做得和Google还差几个数量级（你见过实时统计有百度那么不实时的么？），但是在国内因为墙的关系常常还是只能用。</p>

<p>再比如SMS网关，国外有大量的类似<a href="https://www.twilio.com/sms/toll-free">Twilio</a>的优质服务，价格便宜，接口良好，但是&hellip;我们都用亿美。</p>

<p>值得一提的是推送消息服务，因为被百度坑过，我们一开始用了我浙大著名创业公司“个推”，结果质量低得还比较离谱。最后好死不死又换到了百度Push：原因还是因为Google原生的Push被墙。</p>

<a name="Business.Tools"></a>
<h2>Business Tools</h2>

<p><img src="/downloads/images/2015_01/p4f_stack_business_tools.png" title="Don't touch me..." alt="stack_devops_1" /></p>

<p>其实Trello和Slack这样的工具用好一个就足以撑起一家中等规模的公司了。可惜因为经常被墙，很多不能自己翻墙的同事或者客户用起来倍感艰辛。</p>

<p>整个公司的任务驱动主要还是靠Jira，知识分享和管理主要是靠Confluence。</p>

<p>阿勒！</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2015/01/p4f-tech-stack-part-1-devops/">Goodbye Palm4fun, and the Tech Stack Review Part I</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-04T14:44:23+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:44 pm</span></time>
        
           | <a href="/2015/01/p4f-tech-stack-part-1-devops/#disqus_thread"
             data-disqus-identifier="http://lenciel.cn/2015/01/p4f-tech-stack-part-1-devops/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/2015_01/goodbye_palm4fun.png" title="Don't touch me..." alt="goodbye" /></p>

<p>大概两年前，和Bergkamp、194一次计划外的聊天之后，<strike>出于保护直肠的目的</strike>，本座离开了基友密布的<a href="http://www.myriadgroup.com/">Myriad</a>，作为Palm4fun的联合创始人之一，开始捣鼓着自己创业。</p>

<p>在具体的研发工作方面，我主要是负责服务器端的开发。但因为被冠名CTO，我的工作还包括：</p>

<ul>
<li>制定研发流程，管理运作研发团队（很幸运，团队都是气味相投的小伙伴并且平均水平很高）</li>
<li>搭建和维护各种IT系统让大家的工作更加轻松</li>
<li>对各种项目进行技术选型、风险评估和报价</li>
<li>培养有palm4fun自己特色的团队文化</li>
<li>甚至是，设计我们的logo和<a href="http://lenciel.cn/2014/09/logo-test/">T-Shirt</a></li>
</ul>


<p>别误会，并不是和写代码比，我更喜欢做这些事情：我做这些，主要是经过多年的折腾，已经对自己想在什么样的环境里进行软件开发有了自己的体会。所以，我当然愿意花时间和小伙伴们一起，把理想中的工作环境具体到实践。</p>

<p>经过这两年的时间，虽然我们有纯技术团队创业理应遭遇的各种捉襟见肘，但因为整个团队的坚持和付出，在活下来的同时，也完成了一定的技术积累。有一个可喜的现象是，我们自己参与开发孵化的项目，虽然有一些死掉了，但也有一些拿到了几百万的天使投资；而我们作为外包方参与研发的项目，客户都非常认可我们的项目质量和工作方式。很多客户不但和我们确定了长期合作的关系，还积极介绍自己朋友的项目给我们。</p>

<p>新年到来之际，随着我们被<a href="http://www.testbird.com/">Testbird</a>收编，Palm4fun大部分成员即将投入到新公司的各条战线，Palm4fun作为一个组织也就此消亡了。回首这两年，我想说，如果你没有和我一起经历那说了你也不懂我还是不说了&hellip;&hellip;</p>

<p>跨年的时候，茕茕孑立的本座画了张思维导图，主要目的是把过去两年palm4fun的积累整理一下。画出来之后很多朋友希望我分享高清无码图：因为整个图非常大，不太适合在移动设备上看。</p>

<p><img src="/downloads/images/2015_01/p4f_stack_all.png" title="Don't touch me..." alt="stack_all" /></p>

<p>其实在一开始选择这些的时候，基本上就是从运维支撑和测试部署工具、产品开发和数据管理、基础设施和功能模块以及商业工具四个维度出发，所以就拆成四个部分简单过一遍。特别声明：选择的依据和出发点主要是根据个人喜好，包括自己使用的体验以及眼缘，并没有特别的理由。比如我们用Reviewboard不用Phabricator，完全是因为团队中大多数人已经用习惯了。</p>

<a name="Build.Test.Deploy"></a>
<h2>Build/Test/Deploy</h2>

<p><img src="/downloads/images/2015_01/p4f_stack_devops_1.png" title="Don't touch me..." alt="stack_devops_1" /></p>

<ul>
<li>我们没有用Gerrit或者Phabricator的原因是它们功能太多了</li>
<li>Ngrok是做微信接口调试时意外发现的好物</li>
</ul>


<a name="Monitoring"></a>
<h2>Monitoring</h2>

<p><img src="/downloads/images/2015_01/p4f_stack_devops_2.png" title="Don't touch me..." alt="stack_devops_2" /></p>

<ul>
<li>Sentry帮我们在用户找到我们之前找到了很多问题</li>
<li>一开始我们用过Nagios，它的设计也很不错，就是界面太&hellip;</li>
<li>Zabbix帮我们远离主机因为硬盘满了或者内存不够驾崩的场面</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/12/making-fixture-with-factory-boy-and-faker/">Making Fixture With Factory Boy and Faker</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-20T03:14:59+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:14 am</span></time>
        
           | <a href="/2014/12/making-fixture-with-factory-boy-and-faker/#disqus_thread"
             data-disqus-identifier="http://lenciel.cn/2014/12/making-fixture-with-factory-boy-and-faker/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>我们在Django项目的开发和测试过程中经常需要mock一些数据作为<a href="https://docs.djangoproject.com/en/1.7/howto/initial-data/">fixture</a>，比较常见的做法是：</p>

<ol>
<li>进行一些操作创建测试数据</li>
<li>使用<code>dumpdata</code>命令导出json格式的数据</li>
<li>以导出的json为模板构造测试数据用<code>loaddata</code>命令导入到数据库</li>
</ol>


<p>这样对于大多数场景也算够用了，但是你总会遇到某一天客户走来说：“我想看看那个报表生成出来啥样，能不能创建两千条记录？”</p>

<p>这种时候你大概你第一反应是把之前那个json搞来copy-paste出两千份数据。但很快你就会意识到那是不行的：要构建一个对象，你常常需要先构建它外键的对象，而实际上线的项目它的数据库结构是非常复杂的（数据库结构图的生成见<a href="http://lenciel.cn/2014/12/integrate-schemaspy-with-sphinx-build-for-django-database-design-visualization/">这里</a>），所以构建两千条记录的工作量会远远超过你的想象：</p>

<p><img src="/downloads/images/2014_12/database_design_visualization.png" title="schemaSpy..." alt="schemaSpy" /></p>

<p>最近本座试用了<a href="https://github.com/rbarrois/factory_boy/">factory boy</a>和<a href="https://github.com/joke2k/faker">faker</a>的组合，感觉还比较好用。</p>

<a name="Factory.Boy"></a>
<h2>Factory Boy</h2>

<p>最开始找这类批量生成测试数据的库，主要考察的是<a href="https://github.com/vandersonmota/model_mommy">Model Mommy</a>和<a href="https://github.com/rbarrois/factory_boy/">Factory Boy</a>。看了一下文档感觉两者的差别并不算很大，但是<a href="http://movie.douban.com/subject/1898357/">Factory Girl</a>里面的<a href="http://movie.douban.com/celebrity/1003485/">Sienna Miller</a>实在是让人过目不忘所以有什么好犹豫的呢？</p>

<p>Factories的文档上说明了基本的用法，需要注意的主要是如何生成有一定依赖关系的一组测试对象。</p>

<a name="L............"></a>
<h3>数据构造</h3>

<p>Factory Boy下的数据构造主要是通过<code>Sequence</code>和<code>Fuzz</code>两个包来完成。</p>

<p><code>Sequence</code>故名思议是顺序生成的，比如你要让生成的数据有规律的用户名和电话号码，这样你看到电话<code>13000000001</code>就是是对应<code>user0001</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s">u&#39;user</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="n">phone</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s">u&#39;1300000</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>而<code>Fuzz</code>则是随机的，主要用来构造像学校、专业或者生日这样的数据：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">card_bank</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s">u&#39;中国银行&#39;</span><span class="p">,</span> <span class="s">u&#39;中国招商银行&#39;</span><span class="p">,</span> <span class="s">u&#39;中国工商银行&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">u&#39;中国建设银行&#39;</span><span class="p">,</span> <span class="s">u&#39;成都银行&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">major</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s">u&#39;地球物理学&#39;</span><span class="p">,</span> <span class="s">u&#39;大气科学&#39;</span><span class="p">,</span> <span class="s">u&#39;海洋科学&#39;</span><span class="p">,</span> <span class="s">u&#39;力学&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;农业工程&#39;</span><span class="p">,</span> <span class="s">u&#39;环境科学&#39;</span><span class="p">,</span> <span class="s">u&#39;心理学&#39;</span><span class="p">,</span> <span class="s">u&#39;统计学&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;系统科学&#39;</span><span class="p">,</span> <span class="s">u&#39;地矿&#39;</span><span class="p">,</span> <span class="s">u&#39;机械&#39;</span><span class="p">,</span> <span class="s">u&#39;仪器仪表&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;能源动力&#39;</span><span class="p">,</span> <span class="s">u&#39;电气信息&#39;</span><span class="p">,</span> <span class="s">u&#39;土建&#39;</span><span class="p">,</span> <span class="s">u&#39;测绘&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;环境与安全&#39;</span><span class="p">,</span> <span class="s">u&#39;化工与制药&#39;</span><span class="p">,</span> <span class="s">u&#39;交通运输&#39;</span><span class="p">,</span> <span class="s">u&#39;海洋工程;&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;航空航天&#39;</span><span class="p">,</span> <span class="s">u&#39;武器&#39;</span><span class="p">,</span> <span class="s">u&#39;工程力学&#39;</span><span class="p">,</span> <span class="s">u&#39;生物工程&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;公安技术&#39;</span><span class="p">,</span> <span class="s">u&#39;材料科学&#39;</span><span class="p">,</span> <span class="s">u&#39;材料&#39;</span><span class="p">,</span> <span class="s">u&#39;水利&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;林业工程&#39;</span><span class="p">,</span> <span class="s">u&#39;轻工纺织食品&#39;</span><span class="p">,</span> <span class="s">u&#39;电子信息科学&#39;</span><span class="p">,</span> <span class="s">u&#39;其他&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">birthday</span> <span class="o">=</span> <span class="n">FuzzyNaiveDateTime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1992</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1996</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然，有的字段，比如姓名、地址这类通过顺序或者是随机的从某个设定的集合抽取效果都不够理想，后面会看到怎么用<a href="https://github.com/joke2k/faker">faker</a>来构造它们。</p>

<a name="L.................."></a>
<h3>关联对象生成</h3>

<p>关联对象的关系有很多种(1:1, 1:n, n:1, n:n)，主要都是通过组合运用<code>SubFactory</code>和<code>RelatedFactory</code>两者来生成，但具体的构造方式和先构造谁都要以实际情况而定。比如我们有User和Tester这样的1:1的关系：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Tester</span><span class="p">(</span><span class="n">TimeBaseModel</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;账号&#39;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;tester&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里在考虑是在<code>TesterFactory</code>里面把<code>User</code>作为<code>SubFactory</code>来生成，还是在<code>UserFactory</code>里面把<code>Tester</code>作为<code>RelatedFactory</code>来生成，主要就是看先后关系。很显然，在这里我们应该先构造系统里的User：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TestUserFactory</span><span class="p">(</span><span class="n">UserFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">tester</span> <span class="o">=</span> <span class="n">RelatedFactory</span><span class="p">(</span><span class="s">&#39;apps.tester.factories.TesterFactory&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这段代码告诉系统，在每个<code>TestUser</code>被构造的时候，用构造出来的<code>user</code>来创建一个1:1的<code>Tester</code>。这个<code>Tester</code>的构造会在<code>user</code>的<code>save</code>之前完成。</p>

<p>然后在<code>Tester</code>的构造过程中你可以直接通过<code>SelfAttribute</code>使用传入的<code>user</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">phone</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user.phone&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">nick_name</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user.nick_name&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">creator</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>再比如，我们的<code>Tester</code>和<code>PlatformTask</code>都会关联到测试任务<code>TesterTask</code>，它们俩看起来都是<code>ForeinKey</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterTask</span><span class="p">(</span><span class="n">TestingDeviceMixin</span><span class="p">,</span> <span class="n">TimeBaseModel</span><span class="p">):</span>
</span><span class='line'>    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Tester</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;测试人&#39;</span><span class="p">,</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">platform_task</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">PlatformTask</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;任务&#39;</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">related_name</span><span class="o">=</span><span class="s">u&#39;tester_tasks&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>但对生成数据而言，我们的目标会是每个<code>Tester</code>在被创建的时候，都给它创建一个以这个<code>Tester</code>为<code>owner</code>的<code>TesterTask</code>，并且给这个<code>TesterTask</code>创建一个关联的<code>PlatformTask</code>。</p>

<p>于是我们的写法就会是，首先在<code>TesterFactory</code>里面使用<code>RelatedFactory</code>来创建<code>TesterTask</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">tester_task</span> <span class="o">=</span> <span class="n">RelatedFactory</span><span class="p">(</span><span class="s">&#39;apps.tester.factories.TesterTaskFactory&#39;</span><span class="p">,</span> <span class="s">&#39;owner&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在<code>TesterTaskFactory</code>里面创建<code>PlatformTask</code>，并且在构造的时候使用传入的<code>owner</code>的参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterTaskFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">platform_task</span> <span class="o">=</span> <span class="n">SubFactory</span><span class="p">(</span><span class="s">&#39;apps.platformtask.factories.PlatformTaskFactory&#39;</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">company</span><span class="o">=</span><span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;..owner.user.company&#39;</span><span class="p">),</span>
</span><span class='line'>                               <span class="n">owner</span><span class="o">=</span><span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;..owner.user&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<a name="faker"></a>
<h2>faker</h2>

<p>有很多字段，比如姓名、地址这些，纯粹用Fuzz的办法很难做到“贴近真实”。<a href="https://github.com/joke2k/faker">faker</a>就是用来解决这类字段的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Factory</span>
</span><span class='line'><span class="n">fake</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span><span class='line'><span class="c"># &#39;Lucy Cechtelar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">address</span><span class="p">()</span>
</span><span class='line'><span class="c"># &quot;426 Jordy Lodge</span>
</span><span class='line'><span class="c">#  Cartwrightshire, SC 88120-6700&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span class='line'><span class="c"># Sint velit eveniet. Rerum atque repellat voluptatem quia rerum. Numquam excepturi</span>
</span><span class='line'><span class="c"># beatae sint laudantium consequatur. Magni occaecati itaque sint et sit tempore. Nesciunt</span>
</span><span class='line'><span class="c"># amet quidem. Iusto deleniti cum autem ad quia aperiam.</span>
</span><span class='line'><span class="c"># A consectetur quos aliquam. In iste aliquid et aut similique suscipit. Consequatur qui</span>
</span><span class='line'><span class="c"># quaerat iste minus hic expedita. Consequuntur error magni et laboriosam. Aut aspernatur</span>
</span><span class='line'><span class="c"># voluptatem sit aliquam. Dolores voluptatum est.</span>
</span><span class='line'><span class="c"># Aut molestias et maxime. Fugit autem facilis quos vero. Eius quibusdam possimus est.</span>
</span><span class='line'><span class="c"># Ea quaerat et quisquam. Deleniti sunt quam. Adipisci consequatur id in occaecati.</span>
</span><span class='line'><span class="c"># Et sint et. Ut ducimus quod nemo ab voluptatum.</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个包最可爱的地方就是支持本地化，比如一个随机的中文姓名可以这么去构造：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">faker</span> <span class="o">=</span> <span class="n">FakerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&#39;zh_CN&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="n">lazy_attribute</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<a name="L......fixture"></a>
<h2>生成fixture</h2>

<p>因为<a href="https://github.com/rbarrois/factory_boy/">factory boy</a>和<a href="https://github.com/joke2k/faker">faker</a>主要的作用是在测试里面去mock数据，所以要用它们生成fixture不是那么容易。这是因为Django的整个设计上就很注意避免你把测试的数据写到生产的数据库，所以测试都会在一个在<code>Setup</code>阶段被创建，在<code>TearDown</code>阶段被删除的临时数据库里面进行（我看了一下，在开发版本的Django上已经加了一个<code>--keepdb</code>的参数使得你可以<a href="https://docs.djangoproject.com/en/dev/ref/django-admin/#django-admin-option---keepdb">保留你用来运行测试的数据库了</a>）。</p>

<p>所以我们可以在一个测试的<code>Setup</code>阶段把数据生成后，直接调用<code>dumpdata</code>命令来把数据<code>dump</code>出去：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">company</span> <span class="o">=</span> <span class="n">CompanyFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="n">TestUserFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
</span><span class='line'>    <span class="n">TestUserFactory</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#for test_user in test_users:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">create_fixture</span><span class="p">(</span><span class="s">&#39;tester&#39;</span><span class="p">,</span> <span class="s">&#39;tester.json&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">create_fixture</span><span class="p">(</span><span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="s">&#39;account.json&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意，这里在创建的时候指定id主要是为了让初始的id比较大，避免和系统里面已经有的id撞车导致你构造的测试数据在<code>loaddata</code>的时候报错或者覆盖现有数据。</p>

<p>其中，<code>create_fixture</code>函数内容如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">create_fixture</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span class='line'>    <span class="n">buf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span class='line'>    <span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s">&#39;dumpdata&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
</span><span class='line'>    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
Blog theme: <a href="https://github.com/lenciel/octopress-theme-lenciel">Octopress-Lenciel 0.1</a>
<span class="theme-version">Copyright &copy; 2015 - Lenciel Li</span>
  <section class="contruction-wrap">
    <div class="contruction"></div>
  </section>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lencielgithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
