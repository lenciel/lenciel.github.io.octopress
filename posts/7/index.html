
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>@Lenciel</title>
  <meta name="author" content="Lenciel Li">

  
  <meta name="description" content="Problem 就像截图上显示的那样，真正上线过的Django项目都会好像被施放过诅咒一般，让你在某一天看到那个诡异的example.com。 它可能是在系统发出去的重置密码的邮件里面，可能是在Sentry显示的日志里面，也可能就在你用 site_name tag渲染的模板里面。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://lenciel.com/posts/7">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/libs/jquery.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml">
  
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lenciel.com/posts/7" />
<meta property="og:description" content="Problem 就像截图上显示的那样，真正上线过的Django项目都会好像被施放过诅咒一般，让你在某一天看到那个诡异的example.com。 它可能是在系统发出去的重置密码的邮件里面，可能是在Sentry显示的日志里面，也可能就在你用 site_name tag渲染的模板里面。 &hellip;" />

<meta property="og:site_name" content="https://lenciel.com" />
<meta property="article:author" content="https://lenciel.com">



<meta itemprop="description" content="Problem 就像截图上显示的那样，真正上线过的Django项目都会好像被施放过诅咒一般，让你在某一天看到那个诡异的example.com。 它可能是在系统发出去的重置密码的邮件里面，可能是在Sentry显示的日志里面，也可能就在你用 site_name tag渲染的模板里面。 &hellip;" />


<!-- Combine multiple fonts into one request -->
<link href="https://fonts.lug.ustc.edu.cn/css?family=PT+Sans:regular,italic,bold,bolditalic|Patua+One|Yanone+Kaffeesatz" rel="stylesheet" type="text/css">


  <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?42345b94bf173b38bef61f873677adfa";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-175991-7', 'auto');
  ga('send', 'pageview');

</script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">@Lenciel</a></h1>
  
    <h2>Thoughts and Rants.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lenciel.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/"><i class="icon-home"></i>Home</a></li>
  <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li>
  <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/11/correct-django-site-name-in-sentry/">Correct Django Site Name During DB Migration</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-02T16:50:40+08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>4:50 pm</span></time>
        
           | <a href="/2014/11/correct-django-site-name-in-sentry/#disqus_thread"
             data-disqus-identifier="https://lenciel.com/2014/11/correct-django-site-name-in-sentry/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/downloads/images/2014_11/sentry_incorrect_site.png" title="Don't touch me..." alt="Vhost threshold" /></p>

<a name="Problem"></a>
<h1>Problem</h1>

<p>就像截图上显示的那样，真正上线过的Django项目都会好像被施放过诅咒一般，让你在某一天看到那个诡异的<code>example.com</code>。</p>

<p>它可能是在系统发出去的重置密码的邮件里面，可能是在Sentry显示的日志里面，也可能就在你用 <code>site_name</code> tag渲染的模板里面。</p>

<p>这个诅咒来自于Django的<a href="https://docs.djangoproject.com/en/1.6/ref/contrib/sites/">sites framework</a>的设计。简单来说，它提供了一个Site对象的<code>manager</code>，来<strong>方便</strong>你用一套代码给多个部署环境使用。换句话说，虽然<code>settings.py</code>文件里面也有一个<code>SITE_NAME</code>，但其实用<code>Site.objects.get_current().name</code>或者是模板里面的<code>site_name</code>取到的不是那个值，而是数据库<code>django_site</code>里面某个<code>site_id</code>对应的Site对象的<code>name</code>。</p>

<p>而如果你<code>syncdb</code>之后没有手工修改过，<code>Site</code>的<code>domain</code>和<code>name</code>都被默认初始化为<code>example.com</code>，这就是问题所在了。</p>

<a name="Solution"></a>
<h1>Solution</h1>

<p>stackoverflow上<a href="http://stackoverflow.com/questions/3430451/using-django-settings-in-templates">得票最高的答案</a>这样把<code>site_name</code>放到<code>response</code>的<code>local()</code>里面或者是直接做个<code>context_processor</code>是可以的。但这样的坏处是完全抛弃了Django自带的<code>sites</code>，需要在用的地方都专门的处理。</p>

<p>如果要继续使用自带的<code>sites</code>，就得自己写类似下面的fixture：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[
</span><span class='line'>  {
</span><span class='line'>    "pk": 1,
</span><span class='line'>    "model": "sites.site",
</span><span class='line'>    "fields": {
</span><span class='line'>      "name": "LeiFun Production",
</span><span class='line'>      "domain": "leifun.net"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  {
</span><span class='line'>    "pk": 2,
</span><span class='line'>    "model": "sites.site",
</span><span class='line'>    "fields": {
</span><span class='line'>      "name": "LeiFun Stage",
</span><span class='line'>      "domain": "stage.leifun.net"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>  {
</span><span class='line'>    "pk": 3,
</span><span class='line'>    "model": "sites.site",
</span><span class='line'>    "fields": {
</span><span class='line'>      "name": "LeiFun Test",
</span><span class='line'>      "domain": "test.leifun.net"
</span><span class='line'>    }
</span><span class='line'>  },
</span><span class='line'>
</span><span class='line'>  {
</span><span class='line'>    "pk": 4,
</span><span class='line'>    "model": "sites.site",
</span><span class='line'>    "fields": {
</span><span class='line'>      "name": "LeiFun Local Dev",
</span><span class='line'>      "domain": "yawp.dev:8000"
</span><span class='line'>    }
</span><span class='line'>  }
</span><span class='line'>]</span></code></pre></td></tr></table></div></figure>


<p>然后在部署的环境里面用<code>django_admin.py</code>或者<code>manage.py</code>运行<code>loaddata</code>。这样的坏处是<code>fixture</code>这东西本来主要是给本地测试生成mock数据的，所以<code>syncdb</code>命令其实不会发起fixture的导入，于是很多时候你部署了新版本之后，会忘记重新导入<code>fixture</code>（其实本来也不该导入fixture)，牛皮癣一样的<code>example.com</code>又回来了。</p>

<a name="Solution.2"></a>
<h1>Solution 2</h1>

<p>通过修改某个现成app的<code>Migration</code>类的<code>forwards</code>方法，强制它读取一次<code>settings</code>文件里面的配置项：</p>

<pre><code class="python">class Migration(DataMigration):

    def forwards(self, orm):
        Site = orm['sites.Site']
        site = Site.objects.get(id=settings.SITE_ID)
        site.domain = settings.DOMAIN_NAME
        site.name = settings.SITE_NAME
        site.save()
</code></pre>

<p>这样一来，就可以在<code>syncdb</code>的时候刷新<code>django_site</code>这张表的配置。</p>

<a name="Solution.Finally"></a>
<h1>Solution Finally</h1>

<p>在Django 1.7里面，这个倒霉的设计<a href="https://docs.djangoproject.com/en/dev/ref/contrib/sites/?from=olddocs">终于被改掉了</a>。</p>

<blockquote><p>To enable the sites framework, follow these steps:</p><p>1. Add &#8216;django.contrib.sites&#8217; to your INSTALLED_APPS setting.<br/>2. Define a SITE_ID setting<br/>3. Run migrate.</p><p>django.contrib.sites registers a post_migrate signal handler which creates a default site named example.com with the domain example.com. This site will also be created after Django creates the test database. To set the correct name and domain for your project, you can use a data migration.</p></blockquote>


<p>不但如此，Django 1.7 还引入了<code>django.contrib.sites.middleware.CurrentSiteMiddleware</code>， 如果启用，就可以直接使用<code>request.site</code>而不需要在你的<code>view</code>里面自己去调用<code>site = Site.objects.get_current()</code>了。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/09/no-happy-ending/">聚散有期</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-22T04:20:15+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>4:20 am</span></time>
        
           | <a href="/2014/09/no-happy-ending/#disqus_thread"
             data-disqus-identifier="https://lenciel.com/2014/09/no-happy-ending/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img alt="block" src="/downloads/images/2014_09/death_words.jpg" style="margin:5px;width:40%" align="left" />上周参加了偶像派她爷爷的90大寿，这周就迎来了她另一位爷爷离世的消息。</p>

<p>这位爷爷是我丈母娘保娘(干妈)的老伴，在一场事后被认为是回光返照的愉快聊天后，他独自在卧室睡去，再也没有醒来。</p>

<p>在睡梦中安静的走掉，再加上93岁的高寿，所以我们当然会互相安慰说，不用太伤心，这是寿终正寝。</p>

<p>但一讲起还没有走的婆婆，大家又会忍不住担心起来。</p>

<p>爷爷从不做农活，也不做家务，每天就喝茶打牌养养鸽子。几十年这么被惯着，不但离了婆婆连饭都不会做，甚至连面都不会下。我没有问过他选择这样生活的原因：也许是当年参加抗美援朝，在那片遥远的冰天雪地耗尽了所有的力气吧。</p>

<p>他们也一直没有孩子。</p>

<p>我们每年会去很多次他们在敖平乡下的家，给他们带些粮油和现金。</p>

<p>每次婆婆知道我们要去，就提前到地里掐好自己种的菜，捡好自己养的鸡下的蛋。等我们到了，就一直在厨房里忙活。有时候天气好，我们就把桌子搬到屋外的院子里面，每个人倒一点儿酒慢慢的喝着边吃边等她在厨房忙完上桌。</p>

<p>那时候她已经八十多岁了。</p>

<p>因为牙齿不好，胃口也开始变差。所以大多数时候，她只不过象征性的吃一点儿，就点上一根烟，带着满足的笑容坐在一旁听我们聊天。她很少说话，听到开心的地方，就拿起酒杯微微地抿一口。</p>

<p>在汶川地震之后，他们村里的人被集中安置居住时，他们又选择了留守。四周的邻居逐渐搬走，岳父岳母也去劝过他们和大家一起搬走好有个照应，但他们拒绝了。</p>

<p>更不要说搬来和我们一起住。</p>

<p>据说理由是在自己地里忙活了一辈子，何必要在别的地方去死。</p>

<p>是啊，人到了一定年纪，在哪里死去终于变成一件迫在眉睫的事情。</p>

<p>不知道从哪次去的时候开始，婆婆就已经忙活不动了。大家好像也没有商量过什么，就默默变成我们开车带他们去镇上的饭馆吃一顿，然后送他们回去。</p>

<p>这过程自然比以前要快了不少，每次告别，我都能看出婆婆眼中的不舍：她是个特别重感情的人。</p>

<p>爷爷走了，她反复告诉岳母：“把那些钱拿去好好把事情办了，剩下几千块钱留给我就行了。”</p>

<p>“反正我十一之后就走了”，她这么说。</p>

<p>大家都不停劝她想开一些，但我们都知道她的倔强。</p>

<p>就好像她本来身体比爷爷要差，但一直倔强地撑着，大概她知道自己走了就没人能像自己一样照顾他。</p>

<p>坦白说，他们的感情既让我敬佩，也常常让我疑惑。</p>

<p>有时候我看着婆婆，会想，她有没有偶尔也后悔过没有一个完整的家庭？和爷爷这样的男人厮守到老，是因为依恋，犹豫，认命，还是别的什么东西？</p>

<p>但仔细想想，可能也没有需要特别努力的地方。</p>

<p>反正人生里美好的不过是一些片断：在某个午后踢球赢了比自己更强的对手，夏天很热的时候吃到冰箱里拿出的熟得正好的西瓜，放肆地看着暗恋的对象她/他也正好看着你，跟相爱的人一起度过没人打扰的夜晚，甚至，没有充满恐惧而是在睡梦中平静死去也是美好的。</p>

<p>能抓住它们就好，别的东西我们自己大概很难掌握。</p>

<p>这也是人类到了一定年纪就拒绝去相信纯粹的东西可以持久的原因。毕竟我们这一生会丢失很多东西：首先是理想主义，然后是激情，接下来是容貌和身材，最后是有趣味的生活。想要保持点什么贯穿始终的东西如此不易，倒不如先否认这些需要认真照看的东西，可以让自己生活得容易一些，死的时候也不会太艰难。</p>

<p>记性太好也是需要移除的错误天赋。就好比记得越牢的号码，变成“您拨打的电话无人接听”的那天就越不堪，还不如记错或者干脆忘得一干二净。</p>

<p>也可以给大家都想个理由，就好像张爱玲写她等胡兰成：“雨声潺潺，像住在溪边。宁愿天天下雨，以为你是因为下雨不来。”</p>

<p>该忘记的忘记，剩下的也糊涂些为好。最好还能幽默一些，强势一些，牙尖嘴利地把自己包裹起来生人勿近。</p>

<p>就好像也在这个月刚刚过世的Joan Rivers说：&#8221;My sex life is so bad, my G-spot has been declared a historical landmark.&#8221;</p>

<p>反正，这世界聚散有期，又有几个人在意这些牙尖嘴利的人真正的心思呢。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/09/logo-test/">T-shirt Testing</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-03T01:04:48+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2014</span></span> <span class='time'>1:04 am</span></time>
        
           | <a href="/2014/09/logo-test/#disqus_thread"
             data-disqus-identifier="https://lenciel.com/2014/09/logo-test/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>其实写点儿代码来画件T-Shirt并不难：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">colors</span> <span class="o">=</span> <span class="n">ximport</span><span class="p">(</span> <span class="s">&quot;colors&quot;</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">font</span><span class="p">(</span> <span class="s">&quot;Courier&quot;</span><span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
</span><span class='line'><span class="n">align</span><span class="p">(</span> <span class="n">CENTER</span> <span class="p">)</span>
</span><span class='line'><span class="n">text_path_line_1</span> <span class="o">=</span> <span class="n">textpath</span><span class="p">(</span> <span class="s">&quot;PALM&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">WIDTH</span><span class="p">)</span>
</span><span class='line'><span class="n">text_path_line_2</span> <span class="o">=</span> <span class="n">textpath</span><span class="p">(</span> <span class="s">&quot;4FUN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">WIDTH</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">resx</span> <span class="o">=</span> <span class="mi">300</span>
</span><span class='line'><span class="n">resy</span> <span class="o">=</span> <span class="mi">80</span>
</span><span class='line'><span class="n">rx</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span class='line'><span class="n">ry</span> <span class="o">=</span> <span class="mf">1.5</span>
</span><span class='line'><span class="n">dotsize</span> <span class="o">=</span> <span class="mf">4.5</span>
</span><span class='line'><span class="n">dx</span> <span class="o">=</span> <span class="n">WIDTH</span>  <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">resx</span> <span class="p">)</span>
</span><span class='line'><span class="n">dy</span> <span class="o">=</span> <span class="n">HEIGHT</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span> <span class="n">resy</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">draw_text</span><span class="p">()</span> <span class="p">:</span>
</span><span class='line'>  <span class="n">nofill</span><span class="p">()</span>
</span><span class='line'>  <span class="n">strokewidth</span><span class="p">(</span> <span class="n">random</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">2.8</span> <span class="p">)</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">clr</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span> <span class="p">[</span>
</span><span class='line'>      <span class="n">colors</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span> <span class="s">&quot;#FFBCA4&quot;</span> <span class="p">),</span>
</span><span class='line'>      <span class="n">colors</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span> <span class="s">&quot;#FFBCA4&quot;</span> <span class="p">),</span>
</span><span class='line'>      <span class="n">colors</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span> <span class="s">&quot;#FF4500&quot;</span> <span class="p">),</span>
</span><span class='line'>      <span class="n">colors</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span> <span class="s">&quot;#D93B00&quot;</span> <span class="p">),</span>
</span><span class='line'>      <span class="n">colors</span><span class="o">.</span><span class="n">hex</span><span class="p">(</span> <span class="s">&quot;#A72D00&quot;</span> <span class="p">)</span> <span class="p">]</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>  <span class="n">clr</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">stroke</span><span class="p">(</span> <span class="n">clr</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">oval</span><span class="p">(</span> <span class="n">pointx</span> <span class="o">+</span> <span class="n">random</span><span class="p">(</span> <span class="o">-</span><span class="n">rx</span><span class="p">,</span> <span class="n">rx</span> <span class="p">),</span> <span class="n">pointy</span> <span class="o">+</span> <span class="n">random</span><span class="p">(</span> <span class="o">-</span><span class="n">ry</span><span class="p">,</span> <span class="n">ry</span> <span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">(</span> <span class="n">resx</span><span class="p">,</span> <span class="n">resy</span> <span class="p">)</span> <span class="p">:</span>
</span><span class='line'>  <span class="n">size</span> <span class="o">=</span> <span class="n">choice</span><span class="p">(</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dotsize</span> <span class="p">]</span> <span class="p">)</span>
</span><span class='line'>  <span class="n">pointx</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">-</span> <span class="n">size</span>
</span><span class='line'>  <span class="n">pointy</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">-</span> <span class="n">size</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">text_path_line_1</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span> <span class="n">pointx</span><span class="p">,</span> <span class="n">pointy</span> <span class="p">)</span> <span class="ow">or</span> <span class="n">text_path_line_2</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span> <span class="n">pointx</span><span class="p">,</span> <span class="n">pointy</span> <span class="p">)</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">draw_text</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>感受一下，哪个印出来比较好看呢&hellip;</p>

<p><img src="/downloads/images/2014_09/logo1.png" title="Don't touch me..." alt="Vhost threshold" />
<img src="/downloads/images/2014_09/logo2.png" title="Don't touch me..." alt="Vhost threshold" />
<img src="/downloads/images/2014_09/logo3.png" title="Don't touch me..." alt="Vhost threshold" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2014/09/update-android-sdk-with-proxy/">Update Android Sdk With Shadowsocks Proxy</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-09-02T02:30:35+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>2:30 am</span></time>
        
           | <a href="/2014/09/update-android-sdk-with-proxy/#disqus_thread"
             data-disqus-identifier="https://lenciel.com/2014/09/update-android-sdk-with-proxy/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>博格坎普说，我们android项目的build挂了。</p>

<p>去Jenkins看了一下，日志里面的错误是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[android] $ /usr/local/share/gradle-1.11/bin/gradle clean build
</span><span class='line'>Creating properties on demand (a.k.a. dynamic properties) has been deprecated and is scheduled to be removed in Gradle 2.0. Please read http://gradle.org/docs/current/dsl/org.gradle.api.plugins.ExtraPropertiesExtension.html for information on the replacement for dynamic properties.
</span><span class='line'>Deprecated dynamic property: "buildName" on "ProductFlavorDsl_Decorated{name=main, minSdkVersion=null, targetSdkVersion=null, renderscriptTargetApi=-1, renderscriptSupportMode=null, renderscriptNdkMode=null, versionCode=-1, versionName=null, applicationId=null, testApplicationId=null, testInstrumentationRunner=null, testHandleProfiling=null, testFunctionalTest=null, signingConfig=null, resConfig=null}", value: "1.0.97".
</span><span class='line'>
</span><span class='line'>FAILURE: Build failed with an exception.
</span><span class='line'>
</span><span class='line'>* What went wrong:
</span><span class='line'>A problem occurred configuring project ':app'.
</span><span class='line'>&gt; Could not resolve all dependencies for configuration ':app:_debugCompile'.
</span><span class='line'>   &gt; Could not find com.android.support:appcompat-v7:20.0.0.
</span><span class='line'>     Required by:
</span><span class='line'>         android:app:unspecified
</span><span class='line'>
</span><span class='line'>* Try:
</span><span class='line'>Run with --stacktrace option to get the stack trace. Run with --info or --debug option to get more log output.s</span></code></pre></td></tr></table></div></figure>


<p>这其实在天朝是蛮常见的现象，因为<code>dl-ssl.google.com</code>被封了，所以你总是会因为下面的错误无法更新Android的SDK：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Failed connect to dl-ssl.google.com:443<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Jenkins....................."></a>
<h2>Jenkins服务器配置代理</h2>

<p>这里之所以选择<a href="http://shadowsocks.org/">shadowsocks</a>，是因为可以用自己在<a href="https://developers.google.com/appengine/">Google的VM</a>上配置的shadowsocks代理服务器（顺便广告一下，Google的VM在做活动，几乎是最高配的机器都不要钱，而且第一跳就在美帝，用来做代理非常爽）。</p>

<p>安装shadowsocks的pythohn client:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>pip install shadowsocks
</span><span class='line'>
</span><span class='line'>Downloading/unpacking shadowsocks
</span><span class='line'>  Running setup.py egg_info <span class="k">for</span> package shadowsocks
</span><span class='line'>
</span><span class='line'>    warning: manifest_maker: MANIFEST.in, line 1: <span class="s1">&#39;recursive-include&#39;</span> expects &lt;dir&gt; &lt;pattern1&gt; &lt;pattern2&gt; ...
</span><span class='line'>
</span><span class='line'>Installing collected packages: shadowsocks
</span><span class='line'>  Running setup.py install <span class="k">for</span> shadowsocks
</span><span class='line'>
</span><span class='line'>    warning: manifest_maker: MANIFEST.in, line 1: <span class="s1">&#39;recursive-include&#39;</span> expects &lt;dir&gt; &lt;pattern1&gt; &lt;pattern2&gt; ...
</span><span class='line'>
</span><span class='line'>    Installing sslocal script to /usr/local/bin
</span><span class='line'>    Installing ssserver script to /usr/local/bin
</span><span class='line'>Successfully installed shadowsocks
</span><span class='line'>Cleaning up...
</span></code></pre></td></tr></table></div></figure>


<p>可以看到安装完之后有两个可执行文件，运行其中的<code>sslocal</code>就可以启动shadowsocks的客户端了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@palm4fun-core-1:~/install# sslocal -h
</span><span class='line'>usage: sslocal <span class="o">[</span>-h<span class="o">]</span> -s SERVER_ADDR <span class="o">[</span>-p SERVER_PORT<span class="o">]</span>
</span><span class='line'>               <span class="o">[</span>-b LOCAL_ADDR<span class="o">]</span> <span class="o">[</span>-l LOCAL_PORT<span class="o">]</span> -k PASSWORD <span class="o">[</span>-m METHOD<span class="o">]</span>
</span><span class='line'>               <span class="o">[</span>-t TIMEOUT<span class="o">]</span> <span class="o">[</span>-c CONFIG<span class="o">]</span> <span class="o">[</span>--fast-open<span class="o">]</span> <span class="o">[</span>-v<span class="o">]</span> <span class="o">[</span>-q<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>optional arguments:
</span><span class='line'>  -h, --help            show this <span class="nb">help </span>message and <span class="nb">exit</span>
</span><span class='line'>  -s SERVER_ADDR        server address
</span><span class='line'>  -p SERVER_PORT        server port, default: 8388
</span><span class='line'>  -b LOCAL_ADDR         <span class="nb">local </span>binding address, default: 127.0.0.1
</span><span class='line'>  -l LOCAL_PORT         <span class="nb">local </span>port, default: 1080
</span><span class='line'>  -k PASSWORD           password
</span><span class='line'>  -m METHOD             encryption method, default: aes-256-cfb
</span><span class='line'>  -t TIMEOUT            timeout in seconds, default: 300
</span><span class='line'>  -c CONFIG             path to config file
</span><span class='line'>  --fast-open           use TCP_FASTOPEN, requires Linux 3.7+
</span><span class='line'>  -v, -vv               verbose mode
</span><span class='line'>  -q, -qq               quiet mode, only show warnings/errors
</span><span class='line'>
</span><span class='line'>Online <span class="nb">help</span>: &lt;https://github.com/clowwindy/shadowsocks&gt;
</span></code></pre></td></tr></table></div></figure>


<p>最简单的办法就是新建一个配置文件：</p>

<figure class='code'><figcaption><span>~/.shadowconfig</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;server&quot;</span><span class="o">:</span><span class="s2">&quot;my_server_ip&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;server_port&quot;</span><span class="o">:</span><span class="mi">8388</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;local_port&quot;</span><span class="o">:</span><span class="mi">1080</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;password&quot;</span><span class="o">:</span><span class="s2">&quot;barfoo!&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;timeout&quot;</span><span class="o">:</span><span class="mi">600</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;method&quot;</span><span class="o">:</span><span class="s2">&quot;table&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>记得在防火墙打开你配置的本地端口，然后运行下面的命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@palm4fun-core-1:~/install# sslocal -c ~/.shadowconfig
</span><span class='line'>INFO: loading config from /root/.shadowconfig
</span><span class='line'>shadowsocks 2.1.0
</span><span class='line'>2014-09-02 00:27:53 INFO     starting <span class="nb">local </span>at 127.0.0.1:1080
</span></code></pre></td></tr></table></div></figure>


<a name="L...............android.sdk"></a>
<h2>命令行更新android sdk</h2>

<p>先配置java命令使用的代理，然后
从命令行更新android sdk。只需要到tools目录下面去跑(<code>-u</code>是不显示GUI，<code>-s</code>是指定不使用ssl链接)：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">export </span><span class="nv">_JAVA_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-DsocksProxyHost=127.0.0.1&quot;</span>
</span><span class='line'><span class="nv">$ </span>android update sdk -u -s --all
</span></code></pre></td></tr></table></div></figure>


<p>注意<code>socksProxyHost</code>的默认端口就是1080，如果你使用了其他端口不能只配ip。</p>

<p>另外，<code>--all</code>是比较猛烈的选项（人家的硬盘就是大，人家的代理就是快嘛），你可以在命令行里面通过filter来安装你需要的东西。</p>

<a name="When.shit.happens"></a>
<h2>When shit happens</h2>

<p>运行起来之后更新非常慢，可以<code>android</code>命令报timeout，而代理那边打出日志：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2014-09-02 00:27:53 INFO     starting <span class="nb">local </span>at 127.0.0.1:1080
</span><span class='line'>2014-09-02 00:28:04 INFO     connecting 74.125.237.1:80
</span><span class='line'>2014-09-02 00:28:04 INFO     connecting 74.125.237.1:80
</span><span class='line'>2014-09-02 00:28:04 INFO     connecting 74.125.237.1:80
</span></code></pre></td></tr></table></div></figure>


<p>因为本座平时上网也是在用Google VM上的这个代理，没理由这么慢。所以就怀疑那个74.125.237.1的地址是被谁在<code>/etc/hosts</code>里面给配了固定ip。打开一看果然有：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>dl-ssl.google.com 74.125.237.1
</span></code></pre></td></tr></table></div></figure>


<p>估计是之前配置的基友搜索到了类似<a href="http://www.programering.com/a/MjM4YTMwATA.html">这样的文章</a>。这也是为什么我从来不用也不推荐别人用修改hosts文件的方法来翻墙的原因：它们总是在过期。</p>

<p>Last but not the least, Fuck you, GFW.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/8">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/6">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
Blog theme: <a href="https://github.com/lenciel/octopress-theme-lenciel">Octopress-Lenciel 0.1</a>
<span class="theme-version">Copyright &copy; 2016 - Lenciel Li</span>
  <section class="contruction-wrap">
    <div class="contruction"></div>
  </section>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lencielgithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>










</body>
</html>
