<!DOCTYPE html> <!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]--> <!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]--> <!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]--> <head> <meta charset="utf-8"> <title>@Lenciel</title> <meta name="author" content="Lenciel Li"> <meta name="description" content="大概两年前，和Bergkamp、194一次计划外的聊天之后，出于保护直肠的目的，本座离开了基友密布的Myriad，作为Palm4fun的联合创始人之一，开始捣鼓着自己创业。 在具体的研发工作方面，我主要是负责服务器端的开发。但因为被冠名CTO，我的工作还包括： 制定研发流程，管理运作研发团队（ &hellip;"> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="canonical" href="https://lenciel.com/posts/6"> <link href="/favicon.png" rel="icon"> <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css"> <script src="/javascripts/libs/modernizr.custom.55630.js"></script> <script src="/javascripts/ender.js"></script> <script src="/javascripts/libs/jquery.min.js"></script> <script src="/javascripts/octopress.js" type="text/javascript"></script> <link href="http://feeds.feedburner.com/github/lenciel" rel="alternate" title="@Lenciel" type="application/atom+xml"> <meta property="og:type" content="article"/> <meta property="og:url" content="https://lenciel.com/posts/6"/> <meta property="og:description" content="大概两年前，和Bergkamp、194一次计划外的聊天之后，出于保护直肠的目的，本座离开了基友密布的Myriad，作为Palm4fun的联合创始人之一，开始捣鼓着自己创业。 在具体的研发工作方面，我主要是负责服务器端的开发。但因为被冠名CTO，我的工作还包括： 制定研发流程，管理运作研发团队（ &hellip;"/> <meta property="og:site_name" content="https://lenciel.com"/> <meta property="article:author" content="https://lenciel.com"> <meta itemprop="description" content="大概两年前，和Bergkamp、194一次计划外的聊天之后，出于保护直肠的目的，本座离开了基友密布的Myriad，作为Palm4fun的联合创始人之一，开始捣鼓着自己创业。 在具体的研发工作方面，我主要是负责服务器端的开发。但因为被冠名CTO，我的工作还包括： 制定研发流程，管理运作研发团队（ &hellip;"/> <script type="text/javascript">
  var host = "lenciel.com";
  if ((host == window.location.host) && (window.location.protocol != "https:"))
    window.location.protocol = "https";
</script> <script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?42345b94bf173b38bef61f873677adfa";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-175991-7', 'auto');
  ga('send', 'pageview');

</script> </head> <body class="collapse-sidebar sidebar-footer"> <header role="banner"><hgroup> <h1><a href="/">@Lenciel</a></h1> <h2>Thoughts and Rants.</h2> </hgroup> </header> <nav role="navigation"><ul class="subscription" data-subscription="rss"> <li><a href="http://feeds.feedburner.com/github/lenciel" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li> </ul> <form action="https://google.com/search" method="get"> <fieldset role="search"> <input type="hidden" name="sitesearch" value="lenciel.com"> <input class="search" type="text" name="q" results="0" placeholder="Search"/> </fieldset> </form> <ul class="main-navigation"> <li><a href="/"><i class="icon-home"></i>Home</a></li> <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li> <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li> </ul> </nav> <div id="main"> <div id="content"> <div class="blog-index"> <article> <header> <h1 class="entry-title"><a href="/2015/01/p4f-tech-stack-part-1-devops/">Goodbye Palm4fun, and the Tech Stack Review Part I</a></h1> <p class="meta"> <time class='entry-date' datetime='2015-01-04T14:44:23+08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>4</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:44 pm</span></time> | <a href="/2015/01/p4f-tech-stack-part-1-devops/#disqus_thread" data-disqus-identifier="https://lenciel.com/2015/01/p4f-tech-stack-part-1-devops/">Comments</a> </p> </header> <div class="entry-content"><p><img src="/downloads/images/2015_01/goodbye_palm4fun.png" title="Don't touch me..." alt="goodbye"/></p> <p>大概两年前，和Bergkamp、194一次计划外的聊天之后，<strike>出于保护直肠的目的</strike>，本座离开了基友密布的<a href="http://www.myriadgroup.com/">Myriad</a>，作为Palm4fun的联合创始人之一，开始捣鼓着自己创业。</p> <p>在具体的研发工作方面，我主要是负责服务器端的开发。但因为被冠名CTO，我的工作还包括：</p> <ul> <li>制定研发流程，管理运作研发团队（很幸运，团队都是气味相投的小伙伴并且平均水平很高）</li> <li>搭建和维护各种IT系统让大家的工作更加轻松</li> <li>对各种项目进行技术选型、风险评估和报价</li> <li>培养有palm4fun自己特色的团队文化</li> <li>甚至是，设计我们的logo和<a href="https://lenciel.com/2014/09/logo-test/">T-Shirt</a></li> </ul> <p>别误会，并不是和写代码比，我更喜欢做这些事情：我做这些，主要是经过多年的折腾，已经对自己想在什么样的环境里进行软件开发有了自己的体会。所以，我当然愿意花时间和小伙伴们一起，把理想中的工作环境具体到实践。</p> <p>经过这两年的时间，虽然我们有纯技术团队创业理应遭遇的各种捉襟见肘，但因为整个团队的坚持和付出，在活下来的同时，也完成了一定的技术积累。有一个可喜的现象是，我们自己参与开发孵化的项目，虽然有一些死掉了，但也有一些拿到了几百万的天使投资；而我们作为外包方参与研发的项目，客户都非常认可我们的项目质量和工作方式。很多客户不但和我们确定了长期合作的关系，还积极介绍自己朋友的项目给我们。</p> <p>新年到来之际，随着我们被<a href="http://www.testbird.com/">Testbird</a>收编，Palm4fun大部分成员即将投入到新公司的各条战线，Palm4fun作为一个组织也就此消亡了。回首这两年，我想说，如果你没有和我一起经历那说了你也不懂我还是不说了&hellip;&hellip;</p> <p>跨年的时候，茕茕孑立的本座画了张思维导图，主要目的是把过去两年palm4fun的积累整理一下。画出来之后很多朋友希望我分享高清无码图：因为整个图非常大，不太适合在移动设备上看。</p> <p><img src="/downloads/images/2015_01/p4f_stack_all.png" title="Don't touch me..." alt="stack_all"/></p> <p>其实在一开始选择这些的时候，基本上就是从运维支撑和测试部署工具、产品开发和数据管理、基础设施和功能模块以及商业工具四个维度出发，所以就拆成四个部分简单过一遍。特别声明：选择的依据和出发点主要是根据个人喜好，包括自己使用的体验以及眼缘，并没有特别的理由。比如我们用Reviewboard不用Phabricator，完全是因为团队中大多数人已经用习惯了。</p> <a name="Build.Test.Deploy"></a> <h2>Build/Test/Deploy</h2> <p><img src="/downloads/images/2015_01/p4f_stack_devops_1.png" title="Don't touch me..." alt="stack_devops_1"/></p> <ul> <li>我们没有用Gerrit或者Phabricator的原因是它们功能太多了</li> <li>Ngrok是做微信接口调试时意外发现的好物</li> </ul> <a name="Monitoring"></a> <h2>Monitoring</h2> <p><img src="/downloads/images/2015_01/p4f_stack_devops_2.png" title="Don't touch me..." alt="stack_devops_2"/></p> <ul> <li>Sentry帮我们在用户找到我们之前找到了很多问题</li> <li>一开始我们用过Nagios，它的设计也很不错，就是界面太&hellip;</li> <li>Zabbix帮我们远离主机因为硬盘满了或者内存不够驾崩的场面</li> </ul> </div> </article> <article> <header> <h1 class="entry-title"><a href="/2014/12/making-fixture-with-factory-boy-and-faker/">Making Fixture With Factory Boy and Faker</a></h1> <p class="meta"> <time class='entry-date' datetime='2014-12-20T03:14:59+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:14 am</span></time> | <a href="/2014/12/making-fixture-with-factory-boy-and-faker/#disqus_thread" data-disqus-identifier="https://lenciel.com/2014/12/making-fixture-with-factory-boy-and-faker/">Comments</a> </p> </header> <div class="entry-content"><p>我们在Django项目的开发和测试过程中经常需要mock一些数据作为<a href="https://docs.djangoproject.com/en/1.7/howto/initial-data/">fixture</a>，比较常见的做法是：</p> <ol> <li>进行一些操作创建测试数据</li> <li>使用<code>dumpdata</code>命令导出json格式的数据</li> <li>以导出的json为模板构造测试数据用<code>loaddata</code>命令导入到数据库</li> </ol> <p>这样对于大多数场景也算够用了，但是你总会遇到某一天客户走来说：“我想看看那个报表生成出来啥样，能不能创建两千条记录？”</p> <p>这种时候你大概你第一反应是把之前那个json搞来copy-paste出两千份数据。但很快你就会意识到那是不行的：要构建一个对象，你常常需要先构建它外键的对象，而实际上线的项目它的数据库结构是非常复杂的（数据库结构图的生成见<a href="http://lenciel.com/2014/12/integrate-schemaspy-with-sphinx-build-for-django-database-design-visualization/">这里</a>），所以构建两千条记录的工作量会远远超过你的想象：</p> <p><img src="/downloads/images/2014_12/database_design_visualization.png" title="schemaSpy..." alt="schemaSpy"/></p> <p>最近本座试用了<a href="https://github.com/rbarrois/factory_boy/">factory boy</a>和<a href="https://github.com/joke2k/faker">faker</a>的组合，感觉还比较好用。</p> <a name="Factory.Boy"></a> <h2>Factory Boy</h2> <p>最开始找这类批量生成测试数据的库，主要考察的是<a href="https://github.com/vandersonmota/model_mommy">Model Mommy</a>和<a href="https://github.com/rbarrois/factory_boy/">Factory Boy</a>。看了一下文档感觉两者的差别并不算很大，但是<a href="http://movie.douban.com/subject/1898357/">Factory Girl</a>里面的<a href="http://movie.douban.com/celebrity/1003485/">Sienna Miller</a>实在是让人过目不忘所以有什么好犹豫的呢？</p> <p>Factories的文档上说明了基本的用法，需要注意的主要是如何生成有一定依赖关系的一组测试对象。</p> <a name="L............"></a> <h3>数据构造</h3> <p>Factory Boy下的数据构造主要是通过<code>Sequence</code>和<code>Fuzz</code>两个包来完成。</p> <p><code>Sequence</code>故名思议是顺序生成的，比如你要让生成的数据有规律的用户名和电话号码，这样你看到电话<code>13000000001</code>就是是对应<code>user0001</code>：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s">u&#39;user</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="n">phone</span> <span class="o">=</span> <span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s">u&#39;1300000</span><span class="si">%04d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>而<code>Fuzz</code>则是随机的，主要用来构造像学校、专业或者生日这样的数据：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">card_bank</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s">u&#39;中国银行&#39;</span><span class="p">,</span> <span class="s">u&#39;中国招商银行&#39;</span><span class="p">,</span> <span class="s">u&#39;中国工商银行&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="s">u&#39;中国建设银行&#39;</span><span class="p">,</span> <span class="s">u&#39;成都银行&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">major</span> <span class="o">=</span> <span class="n">FuzzyChoice</span><span class="p">([</span><span class="s">u&#39;地球物理学&#39;</span><span class="p">,</span> <span class="s">u&#39;大气科学&#39;</span><span class="p">,</span> <span class="s">u&#39;海洋科学&#39;</span><span class="p">,</span> <span class="s">u&#39;力学&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;农业工程&#39;</span><span class="p">,</span> <span class="s">u&#39;环境科学&#39;</span><span class="p">,</span> <span class="s">u&#39;心理学&#39;</span><span class="p">,</span> <span class="s">u&#39;统计学&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;系统科学&#39;</span><span class="p">,</span> <span class="s">u&#39;地矿&#39;</span><span class="p">,</span> <span class="s">u&#39;机械&#39;</span><span class="p">,</span> <span class="s">u&#39;仪器仪表&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;能源动力&#39;</span><span class="p">,</span> <span class="s">u&#39;电气信息&#39;</span><span class="p">,</span> <span class="s">u&#39;土建&#39;</span><span class="p">,</span> <span class="s">u&#39;测绘&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;环境与安全&#39;</span><span class="p">,</span> <span class="s">u&#39;化工与制药&#39;</span><span class="p">,</span> <span class="s">u&#39;交通运输&#39;</span><span class="p">,</span> <span class="s">u&#39;海洋工程;&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;航空航天&#39;</span><span class="p">,</span> <span class="s">u&#39;武器&#39;</span><span class="p">,</span> <span class="s">u&#39;工程力学&#39;</span><span class="p">,</span> <span class="s">u&#39;生物工程&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;公安技术&#39;</span><span class="p">,</span> <span class="s">u&#39;材料科学&#39;</span><span class="p">,</span> <span class="s">u&#39;材料&#39;</span><span class="p">,</span> <span class="s">u&#39;水利&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="s">u&#39;林业工程&#39;</span><span class="p">,</span> <span class="s">u&#39;轻工纺织食品&#39;</span><span class="p">,</span> <span class="s">u&#39;电子信息科学&#39;</span><span class="p">,</span> <span class="s">u&#39;其他&#39;</span><span class="p">])</span>
</span><span class='line'><span class="n">birthday</span> <span class="o">=</span> <span class="n">FuzzyNaiveDateTime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1992</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1996</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure> <p>当然，有的字段，比如姓名、地址这类通过顺序或者是随机的从某个设定的集合抽取效果都不够理想，后面会看到怎么用<a href="https://github.com/joke2k/faker">faker</a>来构造它们。</p> <a name="L.................."></a> <h3>关联对象生成</h3> <p>关联对象的关系有很多种(1:1, 1:n, n:1, n:n)，主要都是通过组合运用<code>SubFactory</code>和<code>RelatedFactory</code>两者来生成，但具体的构造方式和先构造谁都要以实际情况而定。比如我们有User和Tester这样的1:1的关系：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Tester</span><span class="p">(</span><span class="n">TimeBaseModel</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;账号&#39;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;tester&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure> <p>这里在考虑是在<code>TesterFactory</code>里面把<code>User</code>作为<code>SubFactory</code>来生成，还是在<code>UserFactory</code>里面把<code>Tester</code>作为<code>RelatedFactory</code>来生成，主要就是看先后关系。很显然，在这里我们应该先构造系统里的User：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TestUserFactory</span><span class="p">(</span><span class="n">UserFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">tester</span> <span class="o">=</span> <span class="n">RelatedFactory</span><span class="p">(</span><span class="s">&#39;apps.tester.factories.TesterFactory&#39;</span><span class="p">,</span> <span class="s">&#39;user&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>这段代码告诉系统，在每个<code>TestUser</code>被构造的时候，用构造出来的<code>user</code>来创建一个1:1的<code>Tester</code>。这个<code>Tester</code>的构造会在<code>user</code>的<code>save</code>之前完成。</p> <p>然后在<code>Tester</code>的构造过程中你可以直接通过<code>SelfAttribute</code>使用传入的<code>user</code>:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">phone</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user.phone&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">nick_name</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user.nick_name&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">creator</span> <span class="o">=</span> <span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>再比如，我们的<code>Tester</code>和<code>PlatformTask</code>都会关联到测试任务<code>TesterTask</code>，它们俩看起来都是<code>ForeinKey</code>。</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterTask</span><span class="p">(</span><span class="n">TestingDeviceMixin</span><span class="p">,</span> <span class="n">TimeBaseModel</span><span class="p">):</span>
</span><span class='line'>    <span class="n">owner</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Tester</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;测试人&#39;</span><span class="p">,</span> <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">platform_task</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">PlatformTask</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">verbose_name</span><span class="o">=</span><span class="s">u&#39;任务&#39;</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">related_name</span><span class="o">=</span><span class="s">u&#39;tester_tasks&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>但对生成数据而言，我们的目标会是每个<code>Tester</code>在被创建的时候，都给它创建一个以这个<code>Tester</code>为<code>owner</code>的<code>TesterTask</code>，并且给这个<code>TesterTask</code>创建一个关联的<code>PlatformTask</code>。</p> <p>于是我们的写法就会是，首先在<code>TesterFactory</code>里面使用<code>RelatedFactory</code>来创建<code>TesterTask</code>:</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">tester_task</span> <span class="o">=</span> <span class="n">RelatedFactory</span><span class="p">(</span><span class="s">&#39;apps.tester.factories.TesterTaskFactory&#39;</span><span class="p">,</span> <span class="s">&#39;owner&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure> <p>然后在<code>TesterTaskFactory</code>里面创建<code>PlatformTask</code>，并且在构造的时候使用传入的<code>owner</code>的参数：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">TesterTaskFactory</span><span class="p">(</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">platform_task</span> <span class="o">=</span> <span class="n">SubFactory</span><span class="p">(</span><span class="s">&#39;apps.platformtask.factories.PlatformTaskFactory&#39;</span><span class="p">,</span>
</span><span class='line'>                               <span class="n">company</span><span class="o">=</span><span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;..owner.user.company&#39;</span><span class="p">),</span>
</span><span class='line'>                               <span class="n">owner</span><span class="o">=</span><span class="n">SelfAttribute</span><span class="p">(</span><span class="s">&#39;..owner.user&#39;</span><span class="p">))</span>
</span><span class='line'>    <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure> <a name="faker"></a> <h2>faker</h2> <p>有很多字段，比如姓名、地址这些，纯粹用Fuzz的办法很难做到“贴近真实”。<a href="https://github.com/joke2k/faker">faker</a>就是用来解决这类字段的。</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Factory</span>
</span><span class='line'><span class="n">fake</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
</span><span class='line'><span class="c"># &#39;Lucy Cechtelar&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">address</span><span class="p">()</span>
</span><span class='line'><span class="c"># &quot;426 Jordy Lodge</span>
</span><span class='line'><span class="c">#  Cartwrightshire, SC 88120-6700&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">fake</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
</span><span class='line'><span class="c"># Sint velit eveniet. Rerum atque repellat voluptatem quia rerum. Numquam excepturi</span>
</span><span class='line'><span class="c"># beatae sint laudantium consequatur. Magni occaecati itaque sint et sit tempore. Nesciunt</span>
</span><span class='line'><span class="c"># amet quidem. Iusto deleniti cum autem ad quia aperiam.</span>
</span><span class='line'><span class="c"># A consectetur quos aliquam. In iste aliquid et aut similique suscipit. Consequatur qui</span>
</span><span class='line'><span class="c"># quaerat iste minus hic expedita. Consequuntur error magni et laboriosam. Aut aspernatur</span>
</span><span class='line'><span class="c"># voluptatem sit aliquam. Dolores voluptatum est.</span>
</span><span class='line'><span class="c"># Aut molestias et maxime. Fugit autem facilis quos vero. Eius quibusdam possimus est.</span>
</span><span class='line'><span class="c"># Ea quaerat et quisquam. Deleniti sunt quam. Adipisci consequatur id in occaecati.</span>
</span><span class='line'><span class="c"># Et sint et. Ut ducimus quod nemo ab voluptatum.</span>
</span></code></pre></td></tr></table></div></figure> <p>这个包最可爱的地方就是支持本地化，比如一个随机的中文姓名可以这么去构造：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">faker</span> <span class="o">=</span> <span class="n">FakerFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">&#39;zh_CN&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="n">lazy_attribute</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure> <a name="L......fixture"></a> <h2>生成fixture</h2> <p>因为<a href="https://github.com/rbarrois/factory_boy/">factory boy</a>和<a href="https://github.com/joke2k/faker">faker</a>主要的作用是在测试里面去mock数据，所以要用它们生成fixture不是那么容易。这是因为Django的整个设计上就很注意避免你把测试的数据写到生产的数据库，所以测试都会在一个在<code>Setup</code>阶段被创建，在<code>TearDown</code>阶段被删除的临时数据库里面进行（我看了一下，在开发版本的Django上已经加了一个<code>--keepdb</code>的参数使得你可以<a href="https://docs.djangoproject.com/en/dev/ref/django-admin/#django-admin-option---keepdb">保留你用来运行测试的数据库了</a>）。</p> <p>所以我们可以在一个测试的<code>Setup</code>阶段把数据生成后，直接调用<code>dumpdata</code>命令来把数据<code>dump</code>出去：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>    <span class="n">company</span> <span class="o">=</span> <span class="n">CompanyFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="n">TestUserFactory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
</span><span class='line'>    <span class="n">TestUserFactory</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">company</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1500</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">#for test_user in test_users:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">create_fixture</span><span class="p">(</span><span class="s">&#39;tester&#39;</span><span class="p">,</span> <span class="s">&#39;tester.json&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">create_fixture</span><span class="p">(</span><span class="s">&#39;account&#39;</span><span class="p">,</span> <span class="s">&#39;account.json&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure> <p>注意，这里在创建的时候指定id主要是为了让初始的id比较大，避免和系统里面已经有的id撞车导致你构造的测试数据在<code>loaddata</code>的时候报错或者覆盖现有数据。</p> <p>其中，<code>create_fixture</code>函数内容如下：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">create_fixture</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span><span class='line'>    <span class="n">buf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
</span><span class='line'>    <span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s">&#39;dumpdata&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
</span><span class='line'>    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span class='line'>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure> </div> </article> <article> <header> <h1 class="entry-title"><a href="/2014/12/integrate-schemaspy-with-sphinx-build-for-django-database-design-visualization/">Integrate schemaSpy With Sphinx Build</a></h1> <p class="meta"> <time class='entry-date' datetime='2014-12-18T00:26:32+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:26 am</span></time> | <a href="/2014/12/integrate-schemaspy-with-sphinx-build-for-django-database-design-visualization/#disqus_thread" data-disqus-identifier="https://lenciel.com/2014/12/integrate-schemaspy-with-sphinx-build-for-django-database-design-visualization/">Comments</a> </p> </header> <div class="entry-content"><p><img src="/downloads/images/2014_12/schemaSpy.png" title="schemaSpy..." alt="schemaSpy"/></p> <p>在做项目的时候，客户或者合作的部门常常问研发要“数据库设计”。在古代，瀑布式开发的第一个阶段是做架构设计和写文档，所以这样的需求一般都能被“充分满足”。而在我们现在的项目节奏和迭代速度都很快，数据库的设计在项目初期经常也在变化，如何能够比较方便的文档化这些变更？</p> <p>对开发团队内部来说，我个人觉得Django的South或者是1.7之后加入的<a href="https://lenciel.com/2014/08/django-1-dot-7-migrations/">Migration</a>里面每次变更生成的migration文件就已经足够开发人员了解底层的设计发生了什么变化。</p> <p>而对外提供的文档，主要是在更高层级进行设计的沟通，所以之前我们一般是通过<a href="https://github.com/django-extensions/django-extensions">django-extension</a>里面的<code>graph_models</code>命令来生成简单的关系图：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Create a PNG image file called my_project_visualized.png with application grouping</span>
</span><span class='line'><span class="nv">$ </span>./manage.py graph_models -a -g -o my_project_visualized.png
</span></code></pre></td></tr></table></div></figure> <p>效果如下：</p> <p><img src="/downloads/images/2014_12/django_extension.svg" title="django-extension-sample..." alt="django-extension-sample"/></p> <p>这里的图是通过<a href="http://www.graphviz.org/">graphviz</a>来完成的，可以看到一般的了解也足够了，但是缺点主要是：</p> <ol> <li>生成的关系图比较简陋</li> <li>由于是图片，一旦表比较多浏览起来并不是那么灵活</li> </ol> <a name="L......schemaSpy"></a> <h2>使用schemaSpy</h2> <p>于是在新的项目里面本座选用了看起来更美好的<a href="http://schemaspy.sourceforge.net/">schemaSpy</a>，因为：</p> <ol> <li>轻量但支持多种数据库（jdbc），针对Django的test/stage/prod环境都可以使用</li> <li><a href="http://schemaspy.sourceforge.net/sample/">功能非常强大</a>，并且有命令行支持，可以集成到CI</li> </ol> <p>不过和大多数开源工具一样，它的文档也是乱糟糟的。以开发环境为例，我们一般使用sqlite作为数据库，要在Mac下面成功运行schemaSpy连接sqlite，你需要：</p> <ol> <li>下载最新的<a href="http://sourceforge.net/projects/schemaspy/files/">SchemaSpy jar包</a></li> <li>下载最新的<a href="https://bitbucket.org/xerial/sqlite-jdbc">Xerial Sqlite JDBC jar</a>包<code>sqlite-xerial.jar</code></li> <li><p>创建一个<code>sqlite-xerial.properties</code>文件，内容如下：</p> <pre><code class="`"> # Use -dp to override.
 description=SQLite
 connectionSpec=jdbc:sqlite:&lt;db&gt;
 db=database name
 driver=org.sqlite.JDBC
 #you may need to put the full path to the driver depending on your setup
 driverPath=sqlite-jdbc-3.8.7.jar
 selectTablesSql=.tables
</code></pre></li> <li><p>运行命令：</p> <pre><code class="`"> java -jar schemaSpy_5.0.0.jar -t  sqlite-xerial.properties -db ../src/default.db  -o django-testbird -sso
</code></pre></li> </ol> <p>会看到有<code>warning</code>，但是无需惊慌，我看了一下是schemaSpy的作者没有正确的处理<code>[]</code>。</p> <a name="L.........Sphinx"></a> <h2>集成到Sphinx</h2> <p>因为我们的项目都使用了Jenkins自动启动Sphinx来生成文档，所以理想的情况当然是：</p> <ol> <li>修改Django下某个app的<code>models.py</code></li> <li><code>make migration</code>生成migrations文件</li> <li>代码提交并push到gitlab</li> <li>Jenkins调用<code>django management command</code>完成表结构的变更</li> <li>Jenkins自动更新包括数据库设计在内的文档</li> </ol> <p>要实现#5，最简单的办法是在Sphinx文档目录下的<code>Makefile</code>里面加一个<code>target</code>：</p> <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">dbv:</span>
</span><span class='line'>    <span class="n">java</span> <span class="o">-</span><span class="n">jar</span> <span class="n">schemaSpy_5</span><span class="o">.</span><span class="mf">0.0</span><span class="o">.</span><span class="na">jar</span> <span class="o">-</span><span class="n">t</span> <span class="n">sqlite</span><span class="o">-</span><span class="n">xerial</span><span class="o">.</span><span class="na">properties</span> <span class="o">-</span><span class="n">db</span> <span class="o">../</span><span class="n">src</span><span class="o">/</span><span class="k">default</span><span class="o">.</span><span class="na">db</span>  <span class="o">-</span><span class="n">o</span> <span class="n">_db_virtualization</span><span class="o">/</span><span class="n">django</span><span class="o">-</span><span class="n">testproject</span> <span class="o">-</span><span class="n">sso</span>
</span></code></pre></td></tr></table></div></figure> <p>然后在Jenkins调用的脚本里面加上<code>make dbv</code>就可以了。</p> </div> </article> <article> <header> <h1 class="entry-title"><a href="/2014/12/how-i-use-evernote/">How I Use Evernote</a></h1> <p class="meta"> <time class='entry-date' datetime='2014-12-17T14:27:39+08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>17</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:27 pm</span></time> | <a href="/2014/12/how-i-use-evernote/#disqus_thread" data-disqus-identifier="https://lenciel.com/2014/12/how-i-use-evernote/">Comments</a> </p> </header> <div class="entry-content"><p>其实之前也分享了一些<a href="https://lenciel.com/blog/categories/tools-i-use/">自己使用的工具</a>，只是更偏重研发。今天跟另外一个也用Evernote的同事交流了一下我怎么用Evernote，效果还可以，干脆在年关将至的时候分享一下自己日常使用的一些软件。</p> <p>从Evernote开始。</p> <p>进入互联网时代，特别是移动互联网时代之后，获取各种信息变得越来越便捷了，如何管理这些纷繁的信息也自热而然成为一个需求。大多数像我一样的老人，一开始是用<a href="https://digg.com/">dig</a>和<a href="https://delicious.com/">delicious</a>这样基于书签的工具。因为在有google和云笔记本这种东西之前，大家都是靠装满了各种书签的&#8221;收藏夹&#8221;过活（年轻人是不能理解重装机器没有备份收藏夹的伤痛的）。</p> <p>但是这样的系统坏处就是它是&#8221;lazy-loading&#8221;的，你每次需要的时候，需要打开网页（如果你还能想起叫啥并且它们还健在的话）去找原来看到的信息，所以更适合用来做reference的整理。对于你真正希望梳理成自己知识的东西，更好的选择当然是使用所谓的PIM(Personal Information Management)软件。</p> <p>我2010年开始用Evernote，一直用的是免费版(空间对我来说够了，而且我也没有太多分享的需求)，它的优点包括：</p> <ul> <li>多(liang)种(you)多(bu)样(qi)的记录手段</li> <li>丰富灵活的管理方式</li> <li>跨平台跨设备云同步</li> <li>颜色还真水嫩啊</li> </ul> <p>但时间久了，Evernote里面的东西也多了起来。每次要找点儿什么基本上都是靠全文搜索，一直到我读到Michael Hyatt的<a href="http://michaelhyatt.com/evernote-tags.html">这篇文章</a>。</p> <p>简单来说，大多数人用Evernote都是以&#8221;笔记本(Notebook)&ldquo;为容器来整理Note的。Michael的意思是Notebook和Tag比有这么几个弱点：</p> <ol> <li>Notebook数量有限制（个人版250，企业版5000），Tag可以有100000个</li> <li>Notebook和Note是一对一的，Tag和Note是多对一的</li> <li>Notebook只能建一级嵌套（基本上就是说可以Group一下），Tag可以无限制多层级嵌套</li> </ol> <p>所以他推荐了使用Tag来进行Note的管理。</p> <p>除此之外他那篇文章里面还有个很重要的概念就是所有的文章先收到一个叫<code>Inbox</code>的Notebook，处理了之后再放到<code>Cabinet</code>里面去。这其实非常像我们使用邮箱：所有的邮件先被邮件系统放到Inbox，然后我们处理了之后打上相应的标签(ToDo, Later, &hellip;)，最后归档。</p> <p>所以我现在是这么Evernote的。</p> <p>首先，把Notebook减少到两个，一个是<code>Inbox</code>，一个是<code>Archive</code>。它们的作用跟我们的邮箱里面的Inbox和Archive是完全一样的。</p> <p>然后，如果在网上看到觉得还挺有意思的文章，就用Evernote收录到<code>Inbox</code>。</p> <p>注意，收录的时候我都习惯用下面的选项，去掉所有的样式：</p> <p><img src="/downloads/images/2014_12/evernote_chrome_clipper.png" title="Evernote Clipper" alt="Evernote Clipper"/></p> <p>最后，在整理Inbox的时候，对每篇文章做一些修修剪剪，给Note加上合适的Tag，然后放到<code>Archive</code>。可以看到，因为tag可以嵌套和展开，要找到自己感兴趣的文章变得容易很多：</p> <p><img src="/downloads/images/2014_12/evernote_nested_tags.png" title="Evernote Clipper" alt="Evernote Clipper"/></p> </div> </article> <div class="pagination"> <a class="prev" href="/posts/7">&larr; Older</a> <a href="/blog/archives">Blog Archives</a> <a class="next" href="/posts/5">Newer &rarr;</a> </div> </div> <aside class="sidebar"> </aside> </div> </div> <footer role="contentinfo"><p> Blog theme: <a href="https://github.com/lenciel/octopress-theme-lenciel">Octopress-Lenciel 0.1</a> <span class="theme-version">Copyright &copy; 2016 - Lenciel Li</span> <section class="contruction-wrap"> <div class="contruction"></div> </section> </p> </footer> <script type="text/javascript">
      var disqus_shortname = 'lencielgithub';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script> <script type="text/javascript">
  var stylesheet = document.createElement('link');
  stylesheet.href = '/stylesheets/screen.css';
  stylesheet.rel = 'stylesheet';
  stylesheet.type = 'text/css';
  document.getElementsByTagName('head')[0].appendChild(stylesheet);
</script> <script type="text/javascript">
  var stylesheet = document.createElement('link');
  stylesheet.href = '/stylesheets/data-table.css';
  stylesheet.rel = 'stylesheet';
  stylesheet.type = 'text/css';
  document.getElementsByTagName('head')[0].appendChild(stylesheet);
</script> </body> </html>